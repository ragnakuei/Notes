# 判斷正在使用的執行計畫

[參考資料](https://youtu.be/ylqwdUQNOH8)

註：以下語法要用 SSMS 來執行

```sql

-- 1. 重新編譯 SP，會將現有的執行計畫清除
EXEC sp_recompile 'CustOrdersOrders';

-- 2. 執行指定的 SP
exec CustOrdersOrders 'ALFKI'

-- 3. 查詢該 SP 正在使用的執行計畫，可能會有多個
SELECT o.object_id, s.plan_handle, h.query_plan
FROM sys.objects o
inner join sys.dm_exec_procedure_stats s
	on o.object_id = s.object_id
CROSS APPLY sys.dm_exec_query_plan(s.plan_handle) h
WHERE o.object_id = object_id('CustOrdersOrders')

-- 4. 查詢該 SP 指定執行計畫的 attribute value
SELECT *
FROM sys.dm_exec_plan_attributes('0x05000A00F0A9E81E0A0F0A0A0A0A0000')
-- 其中 0x05000A00F0A9E81E0A0F0A0A0A0A0000 就是上述的 s.plan_handle

```

5. 上述查詢結果的 attribute set_options 的 value
要到 [這邊](https://learn.microsoft.com/zh-tw/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-plan-attributes-transact-sql?view=azuresqldb-current) 查詢

其中 [這邊](https://learn.microsoft.com/en-us/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-plan-attributes-transact-sql?view=azuresqldb-current#evaluating-set-options) 就是列出 set_options 的 value 是由哪些 option 組成

假設 set_options 的 value 是 4347
那麼就是 4096 + 128 + 64 + 32 + 16 + 8 + 2 + 1 = 4347
也就是
- 4096: ARITH_ABORT
- 128: ANSI_NULL_DFLT_ON
- 64: QUOTED_IDENTIFIER
- 32: ANSI_NULLS
- 16: ANSI_WARNINGS
- 8: CONCAT_NULL_YIELDS_NULL
- 2: ParallelPlan
- 1: ANSI_PADDING

其中 4096 的 ARITH_ABORT 是指當遇到錯誤時，是否要中斷執行，預設是中斷，也是 SSMS 預設開啟的選項
而一般執行 SP 時，不會帶上此選項
所以 `用一般方式執行 SP` 與 `在 SSMS 上執行 SP`，會是不同的執行計畫

註：
1. 開啟 ARITH_ABORT 的方式是在 SP 內加上 `SET ARITHABORT ON`
1. 關財 SSMS 預設開啟的 ARITHABORT 選項
   - Opsions > Query Execution > SQL Server > Advanced 裡，有一個 SET ARITHABORT 選項，預設是開啟的，關掉即可