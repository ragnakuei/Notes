# 範例 01

```cs
using Microsoft.AspNetCore.Mvc;
using MvcSseDemo.Services;
using MvcSseDemo.Utilities;

namespace MvcSseDemo.Controllers;

public class HomeController : Controller
{
    private static readonly HashSet<HttpContext> _clients = new();
    private static readonly object               _lock    = new();

    private readonly ILogger<HomeController> _logger;
    private readonly VoteService             _voteService;

    public HomeController(ILogger<HomeController> logger,
                          VoteService             voteService)
    {
        _logger      = logger;
        _voteService = voteService;
    }

    [HttpGet]
    public IActionResult Index()
    {
        return View();
    }

    [HttpGet]
    public IActionResult VotePage()
    {
        return View();
    }

    [HttpGet, Route("api/[Controller]/[Action]")]
    public async Task Subscribe(CancellationToken cancellationToken)
    {
        HttpContext.Response.Headers.Add("Content-Type",  "text/event-stream");
        HttpContext.Response.Headers.Add("Cache-Control", "no-cache");

        lock (_lock)
        {
            _clients.Add(HttpContext);
        }

        _logger.LogInformation($"Connect");

        // set retry interval
        await HttpContext.Response.WriteAsync("retry: 1000\n\n");
        
        // 更新目前的資料
        var voteResult     = _voteService.GetVoteResult();
        var voteResultJson = voteResult.ToJson();
        await HttpContext.Response.WriteAsync($"data:{voteResultJson}\n\n");
        await HttpContext.Response.Body.FlushAsync();

        while (!(
                    cancellationToken.IsCancellationRequested
                 || HttpContext.RequestAborted.IsCancellationRequested
                ))
        {
            await Task.Delay(1000);
        }

        lock (_lock)
        {
            _clients.Remove(HttpContext);
        }

        _logger.LogInformation($"Disconnect");
    }

    [HttpPost, Route("api/[Controller]/[Action]")]
    public async Task<IActionResult> Vote([FromBody]int? id)
    {
        _voteService.Vote(id.Value);

        await BroadcastVoteResultAsync();

        return Json(null);
    }

    private async Task BroadcastVoteResultAsync()
    {
        var voteResult     = _voteService.GetVoteResult();
        var voteResultJson = voteResult.ToJson();

        _logger.LogInformation($"SendMessage:{voteResultJson}");

        foreach (var client in _clients)
        {
            await client.Response.WriteAsync($"event:notify\n");
            await client.Response.WriteAsync($"data:{voteResultJson}\n\n");
            await client.Response.Body.FlushAsync();

            await client.Response.WriteAsync($"data:{voteResultJson}\n\n");
            await client.Response.Body.FlushAsync();
        }
    }
}

```

/Home/Index.cshtml


```html
@{
    ViewBag.Title = "Vote Result";
    Layout = "_Layout";
}

<h2>@ViewBag.Tigle</h2>

<a asp-action="VotePage" >Vote Page</a>

<table>
    <thead>
        <tr>
            <th>Id</th>
            <th>Count</th>
        </tr>
    </thead>
    <tbody id="tbody">
    </tbody>
</table>

<script type="module">

    const monitorUrl = '/api/Home/SubScribe'
    const eventSource = new EventSource(monitorUrl);
    
    function subscribe() {
        eventSource.onopen = function ( event ) {
            console.log( 'SSE Open', event );
        };

        eventSource.onmessage = function ( event ) {
            console.log('onmessage', event);
            
            const voteResult = JSON.parse(event.data);
            render(voteResult);
        };

        eventSource.addEventListener("notify", (event) => {
            console.log('notify event',event);
            const voteResult = JSON.parse(event.data);
            render(voteResult);
        });

        eventSource.onerror = function ( event ) {
            console.log( 'SSE Error', event );
        };
    }
    
    function render(voteResult) {
        console.log('voteResult',voteResult);
        
        const tbodyDom =  document.querySelector('#tbody');
        tbodyDom.innerHTML = '';
        
        for (const item of voteResult) {
            
            const tr = document.createElement('tr');
            
            let td = document.createElement('td');
            td.innerText = item.Id;
            tr.appendChild(td);
            
            td = document.createElement('td');
            td.innerText = item.Count;
            tr.appendChild(td);
            
            tbodyDom.appendChild(tr);
        }
    }

    subscribe();
    render([]);
</script>
```


```html
@using MvcSseDemo.Services
@using Microsoft.AspNetCore.Antiforgery
@inject VoteService voteService
@inject IAntiforgery antiforgery
@{
    ViewBag.Title = "Vote Page";
    Layout = "_Layout";

    var voteItems = voteService.GetVoteResult();
}

<h2>@ViewBag.Title</h2>

<div id="votes"></div>

<script type="module">
    const antiforgery = @Html.Raw(Json.Serialize(antiforgery.GetAndStoreTokens(Context)));
    const voteItems = @Html.Raw(Json.Serialize(voteItems));
    
    const vote = (id) => {
        fetch('/api/Home/Vote', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': antiforgery
            },
            body: JSON.stringify(id)
        })
        .then(res => res.json())
        .then(res => {
            alert('投票已完成');
        });
    }
    
    function render() {
        const votesDom = document.querySelector('#votes');
        votesDom.innerHTML = '';
        
        voteItems.forEach(item => {
            const div = document.createElement('div');
            div.innerHTML = `
                <span>${item.id}</span>
                <button type="button">投票</button>
            `;
            
            div.querySelector('button')
                .addEventListener('click', () => {
                    vote(item.id);
                });
            
            votesDom.appendChild(div);
        });
    }
    
    render();
</script>

```
