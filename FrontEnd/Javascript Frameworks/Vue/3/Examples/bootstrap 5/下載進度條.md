# 下載進度條

- 使用 bootstrap 5 ProgressBar 及 Modal

```html
<html lang="en">

<head>
    <meta charset="utf-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
</head>

<body>

    <div id="app" class="container p-2">
        <div class="my-2 d-flex gap-2">
            <input class="btn btn-primary" type="button" value="Download" v-bind="startAttributes"
                v-on:click="startDownload()" />
            <input class="btn btn-primary" type="button" value="Stop" v-bind="stopAttributes"
                v-on:click="stopDownload()" />
        </div>

        <!-- Progress Bar -->
        <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuemin="0"
                aria-valuemax="100" v-bind="progressAttributes"></div>
        </div>

        <!-- Modal -->
        <div ref="modal_dom" class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {{ modalMsg }}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://unpkg.com/vue@next"></script>
    <script>

        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {

                // -----------------------------------------------------------------------------------------------
                // modal
                // -----------------------------------------------------------------------------------------------

                let modal;
                const modalMsg = ref('');
                const modal_dom = ref(null);
                const openModal = function (msg) {
                    // console.log('open modal');
                    modalMsg.value = msg;
                    modal.show();
                }
                const closeModal = function () {
                    // console.log('close modal');
                    modalMsg.value = '';
                    modal.hide();
                }

                // -----------------------------------------------------------------------------------------------
                // download / progress bar
                // -----------------------------------------------------------------------------------------------


                const isDownloading = ref(false);

                const startAttributes = computed(() => {
                    return {
                        class: 'btn btn-primary',
                        disabled: isDownloading.value
                    }
                });

                const stopAttributes = computed(() => {
                    return {
                        class: 'btn btn-primary',
                        disabled: isDownloading.value == false
                    }
                });

                function startDownload() {
                    isDownloading.value = true;
                    downloadFile('./256MB.zip');
                }

                function stopDownload() {
                    downloadRequest.value.abort();
                    isDownloading.value = false;
                }

                const progressAttributes = computed(() => {
                    return {
                        style: 'width: ' + loadedPercentage.value + '%',
                    }
                });

                const totalSize = ref(0);
                const loadedSize = ref(0);
                const loadedPercentage = computed(() => {
                    return loadedSize.value / totalSize.value * 100;
                });

                function donwloadEvent(e) {

                    switch (e.type) {
                        case 'load':
                            break;
                        case 'loadstart':
                            break;
                        case 'progress':
                            totalSize.value = e.total;
                            // console.log('totalSize.value', totalSize.value);

                            loadedSize.value = e.loaded;
                            // console.log('loadedSize.value', loadedSize.value);
                            break;
                        case 'loadend':
                            if (totalSize.value === loadedSize.value) {
                                isDownloading.value = false;
                                openModal('Download completed!');
                            }
                            break;
                        case 'error':
                            console.log('error');
                            break;
                        case 'abort':
                            console.log('abort');
                            break;
                    }

                }

                function addListeners(xhr) {

                }

                const downloadRequest = ref(new XMLHttpRequest());

                function downloadFile(url) {

                    downloadRequest.value.addEventListener('load', donwloadEvent);
                    downloadRequest.value.addEventListener('loadstart', donwloadEvent);
                    downloadRequest.value.addEventListener('progress', donwloadEvent);
                    downloadRequest.value.addEventListener('loadend', donwloadEvent);
                    downloadRequest.value.addEventListener('error', donwloadEvent);
                    downloadRequest.value.addEventListener('abort', donwloadEvent);

                    downloadRequest.value.open('GET', url, true);
                    downloadRequest.value.responseType = 'blob';
                    downloadRequest.value.onload = function (e) {
                        var data = downloadRequest.value.response;
                        var blobUrl = window.URL.createObjectURL(data);
                        var downloadLink = document.createElement('a');
                        downloadLink.href = blobUrl;
                        downloadLink.download = 'download.zip';
                        downloadLink.click();
                    };
                    downloadRequest.value.send();
                    return downloadRequest.value
                }

                // -----------------------------------------------------------------------------------------------
                // onMounted
                // -----------------------------------------------------------------------------------------------

                onMounted(() => {
                    modal = new bootstrap.Modal(modal_dom.value);
                })

                return {
                    startAttributes,
                    stopAttributes,
                    progressAttributes,
                    startDownload,
                    stopDownload,
                    modal_dom,
                    modalMsg,
                }
            }
        }).mount('#app');


    </script>

</body>

</html>
```